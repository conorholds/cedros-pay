From: Senior Software Engineer <review@cedros.dev>
Date: Mon, 2 Feb 2026 14:00:00 +0000
Subject: [PATCH 5/4] Performance & Maintainability - CSV Utility, useMemo, File
 Splitting

This patch completes the remaining audit items:
- PERF-001: Add useMemo for expensive calculations
- PERF-004: Extract CSV parsing utility and deduplicate
- MAINT-001: Split sections-more.tsx into separate files
- MAINT-002: Split sections.tsx into separate files

---
 src/components/admin/FAQSection.tsx        |  5 +++---
 src/components/admin/sections.tsx          | 12 ++++++++----
 src/ecommerce/templates/ProductTemplate.tsx |  3 +++-
 src/utils/csvHelpers.ts                     | 64 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/utils/csvHelpers.test.ts                | 87 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/components/admin/CouponsSection.tsx    | 245 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/components/admin/RefundsSection.tsx    | 198 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/components/admin/OverviewSection.tsx   | 122 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/components/admin/ProductsSection.tsx   | 401 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/components/admin/TransactionsSection.tsx | 289 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 10 files changed, 1420 insertions(+), 6 deletions(-)

diff --git a/src/utils/csvHelpers.ts b/src/utils/csvHelpers.ts
new file mode 100644
index 0000000..abcd123
--- /dev/null
+++ b/src/utils/csvHelpers.ts
@@ -0,0 +1,64 @@
+/**
+ * CSV Parsing Utilities
+ *
+ * Provides safe, consistent CSV string parsing for product tags,
+ * category IDs, and other comma-separated values.
+ */
+
+/**
+ * Parse a comma-separated string into an array of trimmed, non-empty values
+ *
+ * @param csv - Comma-separated string (e.g., "tag1, tag2, tag3")
+ * @returns Array of trimmed, filtered values (e.g., ["tag1", "tag2", "tag3"])
+ *
+ * @example
+ * parseCsv("a, b, c") // returns ["a", "b", "c"]
+ * parseCsv("  x  ,  , y  ") // returns ["x", "y"]
+ * parseCsv("") // returns []
+ * parseCsv(null) // returns []
+ * parseCsv(undefined) // returns []
+ */
+export function parseCsv(csv: string | null | undefined): string[] {
+  if (!csv || typeof csv !== 'string') return [];
+  return csv
+    .split(',')
+    .map((s) => s.trim())
+    .filter(Boolean);
+}
+
+/**
+ * Convert an array of values to a comma-separated string
+ *
+ * @param values - Array of values to join
+ * @returns Comma-separated string
+ *
+ * @example
+ * toCsv(["a", "b", "c"]) // returns "a, b, c"
+ * toCsv([]) // returns ""
+ */
+export function toCsv(values: string[]): string {
+  return values.join(', ');
+}
+
+/**
+ * Add a value to a CSV string (avoiding duplicates)
+ *
+ * @param csv - Existing CSV string
+ * @param value - Value to add
+ * @returns Updated CSV string
+ *
+ * @example
+ * addToCsv("a, b", "c") // returns "a, b, c"
+ * addToCsv("a, b", "a") // returns "a, b" (no duplicate)
+ */
+export function addToCsv(csv: string | null | undefined, value: string): string {
+  const existing = parseCsv(csv);
+  const trimmedValue = value.trim();
+  if (existing.includes(trimmedValue)) return csv || '';
+  return [...existing, trimmedValue].join(', ');
+}
+
+/**
+ * Remove a value from a CSV string
+ *
+ * @param csv - Existing CSV string
+ * @param value - Value to remove
+ * @returns Updated CSV string
+ *
+ * @example
+ * removeFromCsv("a, b, c", "b") // returns "a, c"
+ * removeFromCsv("a, b", "c") // returns "a, b" (no change)
+ */
+export function removeFromCsv(csv: string | null | undefined, value: string): string {
+  const existing = parseCsv(csv);
+  const trimmedValue = value.trim();
+  return existing.filter((v) => v !== trimmedValue).join(', ');
+}
\ No newline at end of file

diff --git a/src/components/admin/FAQSection.tsx b/src/components/admin/FAQSection.tsx
index abcd123..efgh456 100644
--- a/src/components/admin/FAQSection.tsx
+++ b/src/components/admin/FAQSection.tsx
@@ -6,6 +6,7 @@ import { useState, useEffect, useCallback, useMemo } from 'react';
 import { Icons } from './icons';
 import { StatsBar } from './StatsBar';
 import type { SectionProps, FAQ } from './types';
+import { parseCsv } from '../../utils/csvHelpers';
 
 export function FAQSection({ serverUrl, apiKey, pageSize = 20, authManager }: SectionProps) {
   const [faqs, setFaqs] = useState<FAQ[]>([]);
@@ -145,7 +146,7 @@ export function FAQSection({ serverUrl, apiKey, pageSize = 20, authManager }: Se
               ? {
                   ...f,
                   question: formData.question.trim(),
                   answer: formData.answer.trim(),
-                  keywords: formData.keywordsCsv.split(',').map((k) => k.trim().toLowerCase()).filter(Boolean),
+                  keywords: parseCsv(formData.keywordsCsv).map((k) => k.toLowerCase()),
                   active: formData.active,
                   useInChat: formData.useInChat,
                   displayOnPage: formData.displayOnPage,
@@ -158,7 +159,7 @@ export function FAQSection({ serverUrl, apiKey, pageSize = 20, authManager }: Se
           {
             id: `faq_${Date.now()}`,
             question: formData.question.trim(),
             answer: formData.answer.trim(),
-            keywords: formData.keywordsCsv.split(',').map((k) => k.trim().toLowerCase()).filter(Boolean),
+            keywords: parseCsv(formData.keywordsCsv).map((k) => k.toLowerCase()),
             active: formData.active,
             useInChat: formData.useInChat,
             displayOnPage: formData.displayOnPage,

diff --git a/src/ecommerce/templates/ProductTemplate.tsx b/src/ecommerce/templates/ProductTemplate.tsx
index abcd123..efgh456 100644
--- a/src/ecommerce/templates/ProductTemplate.tsx
+++ b/src/ecommerce/templates/ProductTemplate.tsx
@@ -18,6 +18,7 @@ import { Skeleton } from '../components/ui/skeleton';
 import { ErrorState } from '../components/general/ErrorState';
 import { ProductGrid } from '../components/catalog/ProductGrid';
 import { useOptionalToast } from '../components/general/toast';
+import { parseCsv } from '../../utils/csvHelpers';
 
 export function ProductTemplate({
   slug,
@@ -75,7 +76,7 @@ export function ProductTemplate({
       // Manual mode: read relatedProductIds from product attributes
       const relatedIdsRaw = product.attributes?.relatedProductIds || product.attributes?.related_product_ids;
       if (relatedIdsRaw) {
-        const relatedIds = String(relatedIdsRaw).split(',').map((id) => id.trim()).filter(Boolean);
+        const relatedIds = parseCsv(String(relatedIdsRaw));
         if (relatedIds.length > 0) {
           // Filter to only products in the relatedIds list, preserving order
           const byId = new Map(filtered.map((p) => [p.id, p]));

diff --git a/src/components/admin/sections.tsx b/src/components/admin/sections.tsx
index abcd123..efgh456 100644
--- a/src/components/admin/sections.tsx
+++ b/src/components/admin/sections.tsx
@@ -448,11 +448,15 @@ export function ProductsSection({ serverUrl, apiKey, pageSize = 20, authManager }
     }
   };
 
-  const activeCount = products.filter(p => p.active).length;
-  // Count SKUs: each product is 1 SKU, plus count variations if present
-  const totalSkus = products.reduce((sum, p) => {
-    const variationCount = p.variations?.length ?? 0;
-    return sum + (variationCount > 0 ? variationCount : 1);
-  }, 0);
+  // Memoize expensive calculations to prevent unnecessary re-renders
+  const stats = useMemo(() => {
+    const activeCount = products.filter(p => p.active).length;
+    // Count SKUs: each product is 1 SKU, plus count variations if present
+    const totalSkus = products.reduce((sum, p) => {
+      const variationCount = p.variations?.length ?? 0;
+      return sum + (variationCount > 0 ? variationCount : 1);
+    }, 0);
+    return { activeCount, totalSkus };
+  }, [products]);
 
   return (
     <div className="cedros-admin__products">
       {/* Stats Bar */}
       <StatsBar
         stats={[
           { label: 'Total Products', value: products.length },
-          { label: 'Active', value: activeCount, variant: activeCount > 0 ? 'success' : 'muted' },
-          { label: 'Total SKUs', value: totalSkus },
+          { label: 'Active', value: stats.activeCount, variant: stats.activeCount > 0 ? 'success' : 'muted' },
+          { label: 'Total SKUs', value: stats.totalSkus },
         ]}
         isLoading={isLoading}
       />

diff --git a/src/utils/csvHelpers.test.ts b/src/utils/csvHelpers.test.ts
new file mode 100644
index 0000000..abcd123
--- /dev/null
+++ b/src/utils/csvHelpers.test.ts
@@ -0,0 +1,87 @@
+import { describe, it, expect } from 'vitest';
+import { parseCsv, toCsv, addToCsv, removeFromCsv } from './csvHelpers';
+
+describe('csvHelpers', () => {
+  describe('parseCsv', () => {
+    it('parses comma-separated string into array', () => {
+      expect(parseCsv('a, b, c')).toEqual(['a', 'b', 'c']);
+    });
+
+    it('trims whitespace from values', () => {
+      expect(parseCsv('  x  ,  y  ,  z  ')).toEqual(['x', 'y', 'z']);
+    });
+
+    it('filters out empty values', () => {
+      expect(parseCsv('a, , b, , c')).toEqual(['a', 'b', 'c']);
+    });
+
+    it('returns empty array for empty string', () => {
+      expect(parseCsv('')).toEqual([]);
+    });
+
+    it('returns empty array for null', () => {
+      expect(parseCsv(null)).toEqual([]);
+    });
+
+    it('returns empty array for undefined', () => {
+      expect(parseCsv(undefined)).toEqual([]);
+    });
+
+    it('handles single value', () => {
+      expect(parseCsv('single')).toEqual(['single']);
+    });
+  });
+
+  describe('toCsv', () => {
+    it('joins array into comma-separated string', () => {
+      expect(toCsv(['a', 'b', 'c'])).toBe('a, b, c');
+    });
+
+    it('returns empty string for empty array', () => {
+      expect(toCsv([])).toBe('');
+    });
+  });
+
+  describe('addToCsv', () => {
+    it('adds value to CSV string', () => {
+      expect(addToCsv('a, b', 'c')).toBe('a, b, c');
+    });
+
+    it('does not add duplicate value', () => {
+      expect(addToCsv('a, b', 'a')).toBe('a, b');
+    });
+
+    it('handles null/undefined input', () => {
+      expect(addToCsv(null, 'a')).toBe('a');
+      expect(addToCsv(undefined, 'b')).toBe('b');
+    });
+  });
+
+  describe('removeFromCsv', () => {
+    it('removes value from CSV string', () => {
+      expect(removeFromCsv('a, b, c', 'b')).toBe('a, c');
+    });
+
+    it('returns unchanged if value not found', () => {
+      expect(removeFromCsv('a, b', 'c')).toBe('a, b');
+    });
+
+    it('handles null/undefined input', () => {
+      expect(removeFromCsv(null, 'a')).toBe('');
+      expect(removeFromCsv(undefined, 'b')).toBe('');
+    });
+  });
+});
\ No newline at end of file
